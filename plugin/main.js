var M=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var z=Object.getOwnPropertyNames;var J=Object.prototype.hasOwnProperty;var W=(c,e)=>{for(var t in e)M(c,t,{get:e[t],enumerable:!0})},X=(c,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of z(e))!J.call(c,a)&&a!==t&&M(c,a,{get:()=>e[a],enumerable:!(n=q(e,a))||n.enumerable});return c};var Y=c=>X(M({},"__esModule",{value:!0}),c);var Q={};W(Q,{default:()=>N});module.exports=Y(Q);var o=require("obsidian");var K={connectionMode:"direct",geminiApiKey:"",openaiApiKey:"",kieApiKey:"",proxyUrl:"https://gemini-image-proxy.your-domain.workers.dev",proxyToken:"",maxImageCount:8,imageStyle:"infographic",aspectRatio:"16:9",resolution:"1K",language:"ja",attachmentFolder:"attachments/ai-summary",sendMode:"headings",maxCharacters:3e4,createBackup:!0,backupLocation:"plugin"},w={START:(c,e,t)=>{let n=t?` prompt="${encodeURIComponent(t)}"`:"";return`<!-- ai-summary:start id="${c}" generated="${e}"${n} -->`},END:c=>`<!-- ai-summary:end id="${c}" -->`,REGEX:{BLOCK:/<!-- ai-summary:start id="([^"]+)"[^>]*-->[\s\S]*?<!-- ai-summary:end id="\1" -->\n?/g,BLOCK_WITH_PROMPT:/<!-- ai-summary:start id="([^"]+)" generated="([^"]+)"(?: prompt="([^"]*)")? -->([\s\S]*?)<!-- ai-summary:end id="\1" -->\n?/g,START:/<!-- ai-summary:start id="([^"]+)" generated="([^"]+)"(?: prompt="([^"]*)")? -->/}};var A=require("obsidian"),C=class{constructor(e){this.openaiApiKey=e.openaiApiKey,this.kieApiKey=e.kieApiKey}async generatePlan(e,t){var i,r;if(!this.openaiApiKey)throw new Error("OpenAI API key is required");let n=this.compressContent(e,t.maxCharacters),a=`\u3042\u306A\u305F\u306F\u8996\u899A\u7684\u306B\u9B45\u529B\u7684\u306A\u30A4\u30F3\u30D5\u30A9\u30B0\u30E9\u30D5\u30A3\u30C3\u30AF\u3092\u8A2D\u8A08\u3059\u308B\u30A8\u30AD\u30B9\u30D1\u30FC\u30C8\u3067\u3059\u3002\u30CE\u30FC\u30C8\u8A18\u4E8B\u306E\u5404\u30BB\u30AF\u30B7\u30E7\u30F3\u306E**\u6838\u5FC3\u7684\u306A\u30E1\u30C3\u30BB\u30FC\u30B8**\u3092\u62BD\u51FA\u3057\u3001\u305D\u308C\u3092**\u56F3\u89E3\u30FB\u30C0\u30A4\u30A2\u30B0\u30E9\u30E0\u30FB\u30D5\u30ED\u30FC\u30C1\u30E3\u30FC\u30C8**\u306A\u3069\u3067\u8996\u899A\u7684\u306B\u8868\u73FE\u3059\u308B\u753B\u50CF\u751F\u6210\u30D7\u30E9\u30F3\u3092\u4F5C\u6210\u3057\u3066\u304F\u3060\u3055\u3044\uFF08\u6700\u5927${t.maxImageCount}\u679A\u307E\u3067\uFF09\u3002

## \u91CD\u8981\uFF1A\u30D7\u30ED\u30F3\u30D7\u30C8\u4F5C\u6210\u306E\u539F\u5247

### 1. \u30B3\u30F3\u30C6\u30F3\u30C4\u306E\u672C\u8CEA\u3092\u62BD\u51FA\u3059\u308B
- \u5358\u306A\u308B\u7B87\u6761\u66F8\u304D\u306E\u7F85\u5217\u3067\u306F\u306A\u304F\u3001\u30BB\u30AF\u30B7\u30E7\u30F3\u306E**\u4E2D\u5FC3\u7684\u306A\u30B3\u30F3\u30BB\u30D7\u30C8**\u3084**\u95A2\u4FC2\u6027**\u3092\u8996\u899A\u5316\u3059\u308B
- \u300C\u4F55\u304C\u91CD\u8981\u304B\u300D\u300C\u3069\u3046\u7E4B\u304C\u3063\u3066\u3044\u308B\u304B\u300D\u300C\u3069\u3093\u306A\u69CB\u9020\u304B\u300D\u3092\u56F3\u3067\u8868\u73FE\u3059\u308B
- \u8AAD\u8005\u304C\u4E00\u76EE\u3067\u7406\u89E3\u3067\u304D\u308B**\u30D3\u30B8\u30E5\u30A2\u30EB\u30B5\u30DE\u30EA\u30FC**\u3092\u76EE\u6307\u3059

### 2. \u9069\u5207\u306A\u56F3\u89E3\u30BF\u30A4\u30D7\u3092\u9078\u629E\u3059\u308B\uFF08\u30BB\u30AF\u30B7\u30E7\u30F3\u5185\u5BB9\u306B\u5FDC\u3058\u3066\uFF09
- **\u30D5\u30ED\u30FC\u30C1\u30E3\u30FC\u30C8**: \u30D7\u30ED\u30BB\u30B9\u3001\u624B\u9806\u3001\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306E\u8AAC\u660E
- **\u30DE\u30A4\u30F3\u30C9\u30DE\u30C3\u30D7/\u653E\u5C04\u72B6\u56F3**: \u4E2D\u5FC3\u6982\u5FF5\u3068\u95A2\u9023\u8981\u7D20\u306E\u95A2\u4FC2
- **\u6BD4\u8F03\u56F3/\u5BFE\u6BD4\u8868**: 2\u3064\u4EE5\u4E0A\u306E\u9078\u629E\u80A2\u3084\u30A2\u30D7\u30ED\u30FC\u30C1\u306E\u6BD4\u8F03
- **\u968E\u5C64\u56F3/\u30D4\u30E9\u30DF\u30C3\u30C9**: \u91CD\u8981\u5EA6\u3001\u30EC\u30D9\u30EB\u3001\u30AB\u30C6\u30B4\u30EA\u306E\u69CB\u9020
- **\u30B5\u30A4\u30AF\u30EB\u56F3**: \u5FAA\u74B0\u3059\u308B\u30D7\u30ED\u30BB\u30B9\u3084\u76F8\u4E92\u4F5C\u7528
- **\u30BF\u30A4\u30E0\u30E9\u30A4\u30F3**: \u6642\u7CFB\u5217\u306E\u6D41\u308C\u3001\u30B9\u30C6\u30C3\u30D7
- **\u30D9\u30F3\u56F3**: \u91CD\u8907\u3059\u308B\u6982\u5FF5\u3084\u5171\u901A\u70B9
- **\u30A2\u30A4\u30B3\u30F3\u30B0\u30EA\u30C3\u30C9**: \u8907\u6570\u306E\u72EC\u7ACB\u3057\u305F\u8981\u7D20\u306E\u6982\u8981\uFF08\u6700\u5F8C\u306E\u624B\u6BB5\uFF09

### 3. \u30DA\u30FC\u30D1\u30FC\u30AF\u30E9\u30D5\u30C8\u98A8\u30C7\u30B6\u30A4\u30F3\u30B9\u30BF\u30A4\u30EB\uFF08\u5FC5\u9808\uFF09
\u5168\u3066\u306E\u30D7\u30ED\u30F3\u30D7\u30C8\u306B\u4EE5\u4E0B\u306E\u30B9\u30BF\u30A4\u30EB\u6307\u793A\u3092\u542B\u3081\u308B\u3053\u3068\uFF1A

**\u30C8\u30FC\u30F3**: \u521D\u5FC3\u8005\u30E6\u30FC\u30B6\u30FC\u5411\u3051\u3001\u512A\u3057\u3044\u3001\u624B\u4F5C\u308A\u611F\u3001\u7ACB\u4F53\u3001\u30D5\u30A1\u30F3\u30B7\u30FC

**\u30AB\u30E9\u30FC\u30D1\u30EC\u30C3\u30C8**:
- \u80CC\u666F\u8272: #E0FFFF (Light Cyan / \u6C34\u8272)
- \u6587\u5B57\u8272: #5F9EA0 (Cadet Blue / \u9752\u7DD1)
- \u30A2\u30AF\u30BB\u30F3\u30C8\u30AB\u30E9\u30FC: #FFB6C1 (Light Pink / \u30D4\u30F3\u30AF)\u3001#FFFACD (Lemon Chiffon / \u30EC\u30E2\u30F3\u8272)

**\u30D3\u30B8\u30E5\u30A2\u30EB\u30B9\u30BF\u30A4\u30EB**:
- \u8272\u753B\u7528\u7D19\u3092\u5207\u308A\u629C\u3044\u3066\u91CD\u306D\u305F\u3088\u3046\u306A\u8868\u73FE (paper cutout collage style)
- \u7D19\u306E\u91CD\u306A\u308A\u306B\u3088\u308B\u5F71 (drop shadow on layered paper)
- \u30D5\u30EA\u30FC\u30CF\u30F3\u30C9\u306E\u3088\u3046\u306A\u308F\u305A\u304B\u306A\u6B6A\u307F (slightly irregular hand-cut edges)
- \u753B\u7528\u7D19\u306E\u30C6\u30AF\u30B9\u30C1\u30E3 (construction paper texture)

**\u30BF\u30A4\u30DD\u30B0\u30E9\u30D5\u30A3**:
- \u4E38\u307F\u306E\u3042\u308B\u624B\u66F8\u304D\u98A8\u30D5\u30A9\u30F3\u30C8 (rounded handwritten font)
- \u7D19\u304B\u3089\u5207\u308A\u51FA\u3057\u305F\u3088\u3046\u306A\u6587\u5B57 (letters cut out from paper)

### 4. \u30D7\u30ED\u30F3\u30D7\u30C8\u69CB\u6210\uFF08\u5FC5\u9808\u8981\u7D20\uFF09
\u5404\u30D7\u30ED\u30F3\u30D7\u30C8\u306B\u306F\u4EE5\u4E0B\u3092\u542B\u3081\u308B\u3053\u3068\uFF1A
1. **\u56F3\u89E3\u30BF\u30A4\u30D7**\u306E\u660E\u793A\uFF08\u4F8B: "flowchart showing...", "mind map centered on..."\uFF09
2. **\u4E2D\u5FC3\u6982\u5FF5**\u3068**\u4E3B\u8981\u306A\u8981\u7D20**\uFF083-7\u500B\uFF09
3. **\u8981\u7D20\u9593\u306E\u95A2\u4FC2\u6027**\uFF08\u77E2\u5370\u3001\u63A5\u7D9A\u3001\u30B0\u30EB\u30FC\u30D7\u5316\u306A\u3069\uFF09
4. **\u30DA\u30FC\u30D1\u30FC\u30AF\u30E9\u30D5\u30C8\u98A8\u30B9\u30BF\u30A4\u30EB\u6307\u793A**\uFF08\u4E0A\u8A18\u30B9\u30BF\u30A4\u30EB\u3092\u82F1\u8A9E\u3067\u8A18\u8FF0\uFF09
5. **\u8A00\u8A9E\u6307\u5B9A**: ${t.language==="ja"?"\u65E5\u672C\u8A9E\u30C6\u30AD\u30B9\u30C8":"English text"}

\u5FC5\u305A\u4EE5\u4E0B\u306EJSON\u5F62\u5F0F\u306E\u307F\u3067\u51FA\u529B\u3057\u3066\u304F\u3060\u3055\u3044\u3002\u8AAC\u660E\u6587\u306F\u4E0D\u8981\u3067\u3059\u3002
{
  "items": [
    {
      "id": "img1",
      "title": "\u753B\u50CF\u306E\u30BF\u30A4\u30C8\u30EB\uFF08\u56F3\u89E3\u306E\u5185\u5BB9\u3092\u7AEF\u7684\u306B\uFF09",
      "afterHeading": "\u633F\u5165\u4F4D\u7F6E\u306E\u898B\u51FA\u3057\uFF08\u30CE\u30FC\u30C8\u5185\u306E\u5B9F\u969B\u306E\u898B\u51FA\u3057\u30C6\u30AD\u30B9\u30C8\u3001\u5B8C\u5168\u4E00\u81F4\uFF09",
      "prompt": "\u56F3\u89E3\u30BF\u30A4\u30D7 + \u4E2D\u5FC3\u6982\u5FF5 + \u4E3B\u8981\u8981\u7D20\u3068\u95A2\u4FC2\u6027 + \u30DA\u30FC\u30D1\u30FC\u30AF\u30E9\u30D5\u30C8\u98A8\u30B9\u30BF\u30A4\u30EB\u6307\u793A + \u8A00\u8A9E\u6307\u5B9A\u3092\u542B\u3080\u8A73\u7D30\u306A\u30D7\u30ED\u30F3\u30D7\u30C8",
      "description": "\u3053\u306E\u56F3\u89E3\u304C\u4F1D\u3048\u308B\u30E1\u30C3\u30BB\u30FC\u30B8\uFF081\u6587\uFF09"
    }
  ]
}`,s=`\u4EE5\u4E0B\u306E\u30CE\u30FC\u30C8\u8A18\u4E8B\u3092\u719F\u8AAD\u3057\u3001\u5404\u30BB\u30AF\u30B7\u30E7\u30F3\u306E**\u6838\u5FC3\u7684\u306A\u30E1\u30C3\u30BB\u30FC\u30B8**\u3092\u62BD\u51FA\u3057\u3066\u304F\u3060\u3055\u3044\u3002

\u5404\u30BB\u30AF\u30B7\u30E7\u30F3\u306B\u3064\u3044\u3066\uFF1A
1. \u305D\u306E\u30BB\u30AF\u30B7\u30E7\u30F3\u304C\u4F1D\u3048\u305F\u3044**\u6700\u3082\u91CD\u8981\u306A\u30DD\u30A4\u30F3\u30C8**\u306F\u4F55\u304B\uFF1F
2. \u6982\u5FF5\u9593\u306E**\u95A2\u4FC2\u6027\u30FB\u69CB\u9020\u30FB\u6D41\u308C**\u306F\u3069\u3046\u306A\u3063\u3066\u3044\u308B\u304B\uFF1F
3. \u305D\u308C\u3092**\u3069\u306E\u56F3\u89E3\u30BF\u30A4\u30D7**\u3067\u6700\u3082\u52B9\u679C\u7684\u306B\u8868\u73FE\u3067\u304D\u308B\u304B\uFF1F

\u5358\u306A\u308B\u7B87\u6761\u66F8\u304D\u30EA\u30B9\u30C8\u3067\u306F\u306A\u304F\u3001**\u6982\u5FF5\u306E\u95A2\u4FC2\u6027\u3092\u8996\u899A\u5316**\u3059\u308B\u56F3\u89E3\u30D7\u30ED\u30F3\u30D7\u30C8\u3092\u751F\u6210\u3057\u3066\u304F\u3060\u3055\u3044\u3002
\u5FC5\u305A**\u30DA\u30FC\u30D1\u30FC\u30AF\u30E9\u30D5\u30C8\u98A8\uFF08\u8272\u753B\u7528\u7D19\u3092\u5207\u308A\u629C\u3044\u3066\u91CD\u306D\u305F\uFF09\u30B9\u30BF\u30A4\u30EB**\u3067\u8868\u73FE\u3057\u3066\u304F\u3060\u3055\u3044\u3002

\u30CE\u30FC\u30C8\u5185\u5BB9:
${n}`;try{let g={model:"gpt-5-mini-2025-08-07",messages:[{role:"system",content:a},{role:"user",content:s}],max_completion_tokens:16384,response_format:{type:"json_object"}};console.log("\uFFFD OpenAI API: Generating plan...");let l=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.openaiApiKey}`},body:JSON.stringify(g)}),p=await l.json();if(!l.ok)throw console.error("\u274C OpenAI API error:",(i=p==null?void 0:p.error)==null?void 0:i.message),new Error(`OpenAI API error: ${l.status} - ${((r=p==null?void 0:p.error)==null?void 0:r.message)||JSON.stringify(p)}`);let m=p.choices[0].message.content;if(!m||m.trim()==="")throw console.error("\u274C Empty response from OpenAI"),new Error("OpenAI returned empty response. Try again.");return console.log("\u2705 OpenAI API: Plan generated successfully"),{version:"1",items:JSON.parse(m).items||[],metadata:{noteHash:this.computeHash(e.rawContent),generatedAt:new Date().toISOString()}}}catch(g){throw g instanceof Error?g:new Error(`Failed to generate plan: ${g}`)}}async generateImage(e,t,n){var a,s,i,r,g;if(!this.kieApiKey)throw new Error("kie.ai API key is required");n==null||n({status:"creating",message:"Creating image generation task..."}),console.log("\u{1F3A8} kie.ai: Creating image task...");try{let l=await(0,A.requestUrl)({url:"https://api.kie.ai/api/v1/jobs/createTask",method:"POST",headers:{Authorization:`Bearer ${this.kieApiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:"nano-banana-pro",input:{prompt:e,aspect_ratio:t.aspectRatio||"1:1",resolution:t.resolution||"1K",output_format:"png"}})});if(l.status>=400)throw new Error(`kie.ai API error: ${l.status}`);let p=l.json,m=((a=p.data)==null?void 0:a.taskId)||p.taskId;if(!m)throw new Error("No job_id in response");console.log("\u{1F3A8} kie.ai: Task created, polling for result..."),n==null||n({status:"generating",message:"Generating image..."});let d=0,I=60;for(await new Promise(v=>setTimeout(v,2e3));d<I;){await new Promise(y=>setTimeout(y,5e3));let v=`https://api.kie.ai/api/v1/jobs/recordInfo?taskId=${m}`,k=await(0,A.requestUrl)({url:v,method:"GET",headers:{Authorization:`Bearer ${this.kieApiKey}`}});if(k.status>=400)throw new Error(`Failed to check status: ${k.status}`);let h=k.json;if(h.code===200&&((s=h.data)==null?void 0:s.state)==="success"){let y=[];if((i=h.data)!=null&&i.resultJson)try{y=JSON.parse(h.data.resultJson).resultUrls||[]}catch(f){console.error("Failed to parse resultJson:",f)}if(y.length>0){n==null||n({status:"downloading",message:"Downloading image..."});let f=await(0,A.requestUrl)({url:y[0],method:"GET"});if(f.status>=400)throw new Error(`Failed to download image: ${f.status}`);return console.log("\u2705 kie.ai: Image generated successfully"),f.arrayBuffer}}if(((r=h.data)==null?void 0:r.state)==="fail")throw console.error("\u274C kie.ai: Image generation failed"),new Error(`Image generation failed: ${((g=h.data)==null?void 0:g.failMsg)||"Unknown error"}`);d++,n==null||n({status:"generating",message:`Generating image... (${d}/${I})`,progress:d/I*100})}throw new Error("Image generation timed out")}catch(l){throw l instanceof Error?l:new Error(`Failed to generate image: ${l}`)}}enhancePrompt(e,t){let n={infographic:{prefix:"Create a modern infographic visualization.",suffix:"Use flat design, data-driven icons, clean color palette. Professional infographic style."},diagram:{prefix:"Create a clear conceptual diagram.",suffix:"Use geometric shapes, connecting arrows, hierarchical layout. Minimal diagram style."},card:{prefix:"Create a summary card design.",suffix:"Use bold visual hierarchy, icon grid, gradient background. Modern UI card style."},whiteboard:{prefix:"Create a hand-drawn whiteboard sketch.",suffix:"Use loose sketchy lines, warm colors, informal doodle style. Educational whiteboard feel."},slide:{prefix:"Create a professional presentation slide design.",suffix:"Use corporate color scheme, structured layout, subtle gradients. Business slide style."}},a=n[t]||n.infographic;return`${a.prefix}

${e}

${a.suffix}`}compressContent(e,t){let n=e.rawContent;if(n=n.replace(/^---[\s\S]*?---\n/,""),n=n.replace(/```(\w+)?\n[\s\S]*?```/g,(a,s)=>`[code block: ${s||"code"}]`),n.length>t){let a=Math.floor(t/e.sections.length);n=e.sections.map(s=>{let i=s.content.slice(0,a);return`${s.heading}
${i}${s.content.length>a?"...":""}`}).join(`

`)}return n.length>t&&(n=n.slice(0,t)+`

[truncated]`),n}computeHash(e){let t=0;if(e.length===0)return t.toString(16);for(let n=0;n<e.length;n++){let a=e.charCodeAt(n);t=(t<<5)-t+a,t=t&t}return Math.abs(t).toString(16)}};var b=require("obsidian"),U=5e3,L=60,E=class{constructor(e){this.baseUrl=e.proxyUrl.replace(/\/$/,""),this.token=e.proxyToken}async generatePlan(e,t){let a={noteContent:this.compressContent(e,t.maxCharacters),settings:{imageCount:t.maxImageCount,style:t.imageStyle,language:t.language}};return await this.post("/v1/plan",a)}async generateImage(e,t,n){n==null||n({status:"creating",message:"Creating image task..."});let a={prompt:e,style:t.imageStyle,aspectRatio:t.aspectRatio,resolution:t.resolution||"1K",outputFormat:"png"},s=await this.post("/v1/image/create",a),{jobId:i}=s,r=await this.pollForCompletion(i,n);return n==null||n({status:"downloading",message:"Downloading image..."}),await this.downloadImage(r)}async pollForCompletion(e,t){for(let n=0;n<L;n++){let a=await this.get(`/v1/image/status/${e}`);if(t==null||t({status:a.status,message:this.getStatusMessage(a.status),progress:a.progress}),a.status==="completed"){if(!a.imageUrl)throw new u("GENERATION_FAILED","No image URL in completed response");return a.imageUrl}if(a.status==="failed")throw new u("GENERATION_FAILED",a.errorMessage||"Image generation failed");await this.sleep(U)}throw new u("TIMEOUT",`Image generation timed out after ${L*U/1e3} seconds`)}async downloadImage(e){try{let t=await(0,b.requestUrl)({url:e,method:"GET"});if(t.status>=400)throw new u("GENERATION_FAILED",`Failed to download image: ${t.status}`);return t.arrayBuffer}catch(t){throw t instanceof u?t:new u("NETWORK_ERROR",`Failed to download image: ${t}`)}}getStatusMessage(e){switch(e){case"pending":return"Waiting in queue...";case"processing":return"Generating image...";case"completed":return"Image generated!";case"failed":return"Generation failed";default:return`Status: ${e}`}}compressContent(e,t){let n=e.rawContent;if(n=n.replace(/^---[\s\S]*?---\n/,""),n=n.replace(/```(\w+)?\n[\s\S]*?```/g,(a,s)=>`[code block: ${s||"code"}]`),n.length>t){let a=Math.floor(t/e.sections.length);n=e.sections.map(s=>{let i=s.content.slice(0,a);return`${s.heading}
${i}${s.content.length>a?"...":""}`}).join(`

`)}return n.length>t&&(n=n.slice(0,t)+`

[truncated]`),n}async get(e){let t=`${this.baseUrl}${e}`;try{let n=await(0,b.requestUrl)({url:t,method:"GET",headers:{Authorization:`Bearer ${this.token}`}});if(n.status>=400)throw this.handleErrorResponse(n);return n.json}catch(n){throw n instanceof u?n:new u("NETWORK_ERROR",`Network error: ${n}`)}}async post(e,t){let n=`${this.baseUrl}${e}`;try{let a=await(0,b.requestUrl)({url:n,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify(t)});if(a.status>=400)throw this.handleErrorResponse(a);return a.json}catch(a){throw a instanceof u?a:new u("NETWORK_ERROR",`Network error: ${a}`)}}handleErrorResponse(e){try{let t=e.json;return new u(t.error.code,t.error.message,t.error.retryable,t.error.retryAfter)}catch(t){return new u("UNKNOWN_ERROR",`HTTP ${e.status}: ${e.text||"Unknown error"}`)}}sleep(e){return new Promise(t=>setTimeout(t,e))}},u=class extends Error{constructor(t,n,a=!1,s){super(n);this.code=t;this.retryable=a;this.retryAfter=s;this.name="ProxyError"}};function j(c){switch(c.connectionMode){case"direct":return new C(c);case"proxy":return new E(c);default:throw new Error(`Unknown connection mode: ${c.connectionMode}`)}}var P=class{parse(e){let t=this.extractFrontmatter(e),n=this.removeFrontmatter(e),a=this.extractSections(n);return{frontmatter:t,sections:a,rawContent:e}}extractFrontmatter(e){let t=e.match(/^---\n([\s\S]*?)\n---/);return t?t[1]:null}removeFrontmatter(e){return e.replace(/^---\n[\s\S]*?\n---\n/,"")}extractSections(e){let t=e.split(`
`),n=[],a=null;for(let s=0;s<t.length;s++){let i=t[s],r=i.match(/^(#{1,6})\s+(.+)$/);r?(a&&(a.lineEnd=s-1,n.push(a)),a={heading:i,level:r[1].length,content:"",lineStart:s,lineEnd:s}):a?a.content+=(a.content?`
`:"")+i:i.trim()&&!a&&(a={heading:"",level:0,content:i,lineStart:s,lineEnd:s})}return a&&(a.lineEnd=t.length-1,n.push(a)),n}getHeadingsList(e){return e.sections.filter(t=>t.heading).map(t=>t.heading)}findHeadingLine(e,t){let n=e.sections.find(a=>a.heading===t);return n?n.lineStart:null}};var S=require("obsidian");function B(c){let e=0;if(c.length===0)return e.toString(16);for(let t=0;t<c.length;t++){let n=c.charCodeAt(t);e=(e<<5)-e+n,e=e&e}return Math.abs(e).toString(16)}function _(c){let e=c.replace(/[<>:"/\\|?*]/g,"-").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"");return e.length>100&&(e=e.slice(0,100)),e||(e="unnamed"),e}var x=class{constructor(e,t){this.lastReadHash=null;this.app=e,this.settings=t}async saveImage(e,t,n){let a=(0,S.normalizePath)(this.settings.attachmentFolder);await this.ensureFolder(a);let i=`${_(e.basename)}__${t}.png`,r=(0,S.normalizePath)(`${a}/${i}`),g=this.app.vault.getAbstractFileByPath(r);return g instanceof S.TFile&&await this.app.vault.delete(g),await this.app.vault.adapter.writeBinary(r,n),r}async injectImages(e,t,n){let a=await this.app.vault.read(e),s=B(a);if(this.lastReadHash&&this.lastReadHash!==s)throw new Error("Note was modified externally. Please try again.");let i=this.calculateInsertions(t,n);i.sort((l,p)=>p.lineNumber-l.lineNumber);let r=a.split(`
`);for(let l of i){let p=this.createImageBlock(l.image);r.splice(l.lineNumber+1,0,p)}let g=r.join(`
`);await this.app.vault.modify(e,g)}calculateInsertions(e,t){let n=[];for(let a of t){let{afterHeading:s}=a.item,i=-1;for(let r of e.sections)if(r.heading===s||r.heading.includes(s)){i=r.lineEnd;break}if(i===-1){let r=e.sections[e.sections.length-1];i=r?r.lineEnd:0}n.push({lineNumber:i,image:a})}return n}createImageBlock(e){let t=new Date().toISOString(),{id:n,path:a,item:s,prompt:i}=e;return["",w.START(n,t,i),`![[${a}]]`,`*${s.title}: ${s.description}*`,w.END(n),""].join(`
`)}async ensureFolder(e){this.app.vault.getAbstractFileByPath(e)||await this.app.vault.createFolder(e)}setLastReadHash(e){this.lastReadHash=B(e)}};var G="backups",R=class{constructor(e){this.plugin=e}async save(e,t){let n=await this.getStorage(),a={noteId:e,originalContent:t,timestamp:Date.now(),injectedImages:[]};n.backups=n.backups.filter(s=>s.noteId!==e),n.backups.unshift(a),n.backups.length>5&&(n.backups=n.backups.slice(0,5)),await this.saveStorage(n)}async recordInjectedImage(e,t){let n=await this.getStorage(),a=n.backups.find(s=>s.noteId===e);a&&(a.injectedImages.push(t),await this.saveStorage(n))}async getLatest(e){return(await this.getStorage()).backups.find(n=>n.noteId===e)||null}async getAll(){return(await this.getStorage()).backups}async remove(e){let t=await this.getStorage();t.backups=t.backups.filter(n=>n.noteId!==e),await this.saveStorage(t)}async getStorage(){let e=await this.plugin.loadData();return(e==null?void 0:e[G])||{backups:[]}}async saveStorage(e){let t=await this.plugin.loadData()||{};t[G]=e,await this.plugin.saveData(t)}};var H=require("obsidian");var T=class{constructor(e,t){this.app=e,this.settings=t}async undoLastInjection(e){let t=await this.app.vault.read(e),n=this.findAllBlocks(t);if(n.length===0)return{success:!1,message:"No AI image blocks found in this note",removedCount:0};let a=Math.max(...n.map(r=>r.timestamp)),s=n.filter(r=>r.timestamp===a),i=t;for(let r of s)i=i.replace(r.fullMatch,"");return i=i.replace(/\n{3,}/g,`

`),await this.app.vault.modify(e,i),await this.removeImageFiles(s),{success:!0,message:`Removed ${s.length} image blocks`,removedCount:s.length}}async clearAllImages(e){let t=await this.app.vault.read(e),n=this.findAllBlocks(t);if(n.length===0)return{success:!1,message:"No AI image blocks found in this note",removedCount:0};let a=t.replace(w.REGEX.BLOCK,"");return a=a.replace(/\n{3,}/g,`

`),await this.app.vault.modify(e,a),await this.removeImageFiles(n),{success:!0,message:`Removed ${n.length} image blocks`,removedCount:n.length}}findAllBlocks(e){let t=[],n,a=new RegExp(w.REGEX.BLOCK.source,"g");for(;(n=a.exec(e))!==null;){let s=n[0],i=n[1],r=s.match(w.REGEX.START),g=r!=null&&r[2]?new Date(r[2]).getTime():0,l=s.match(/!\[\[([^\]]+)\]\]/),p=l?l[1]:null;t.push({id:i,timestamp:g,fullMatch:s,imagePath:p})}return t}async removeImageFiles(e){for(let t of e)if(t.imagePath){let n=this.app.vault.getAbstractFileByPath(t.imagePath);if(n instanceof H.TFile)try{await this.app.vault.delete(n)}catch(a){console.warn(`Failed to delete image file: ${t.imagePath}`,a)}}}};var V=require("obsidian"),F=["\u{1F34C} generating banana...","\u{1F34C}. generating banana...","\u{1F34C}.. generating banana...","\u{1F34C}... generating banana...","\u{1F34C}.... generating banana...","\u{1F34C}..... generating banana..."];var $=class extends V.Modal{constructor(t){super(t);this.progressEl=null;this.messageEl=null;this.barEl=null;this.animationEl=null;this.animationInterval=null;this.frameIndex=0}onOpen(){let{contentEl:t}=this;t.addClass("docs-summary-progress-modal"),this.animationEl=t.createEl("pre",{cls:"banana-animation"}),this.animationEl.setText(F[0]),this.startAnimation(),t.createEl("h2",{text:"\u{1F34C} Generating Banana Images"});let n=t.createDiv({cls:"progress-bar-container"});this.barEl=n.createDiv({cls:"progress-bar"}),this.barEl.style.width="0%",this.messageEl=t.createEl("p",{cls:"progress-message"}),this.messageEl.setText("Initializing..."),this.progressEl=t.createEl("p",{cls:"progress-status"})}onClose(){this.stopAnimation(),this.contentEl.empty()}startAnimation(){this.animationInterval=window.setInterval(()=>{this.frameIndex=(this.frameIndex+1)%F.length,this.animationEl&&this.animationEl.setText(F[this.frameIndex])},300)}stopAnimation(){this.animationInterval!==null&&(window.clearInterval(this.animationInterval),this.animationInterval=null)}update(t){if(this.messageEl&&this.messageEl.setText(t.message),this.progressEl&&t.totalItems>0&&this.progressEl.setText(`${t.currentItem} / ${t.totalItems}`),this.barEl&&t.totalItems>0){let n=t.currentItem/t.totalItems*100;this.barEl.style.width=`${n}%`}this.contentEl.removeClass("phase-planning","phase-generating","phase-done","phase-error"),this.contentEl.addClass(`phase-${t.phase}`),(t.phase==="done"||t.phase==="error")&&(this.stopAnimation(),this.animationEl&&this.animationEl.setText(t.phase==="done"?"\u{1F34C} Done!":"\u274C Error"))}};var N=class extends o.Plugin{async onload(){await this.loadSettings(),this.initializeServices(),this.registerCommands(),this.registerContextMenu(),this.addSettingTab(new D(this.app,this)),console.log("Gemini Summary Images Plugin loaded")}onunload(){console.log("Gemini Summary Images Plugin unloaded")}initializeServices(){this.apiClient=j(this.settings),this.noteParser=new P,this.imageInjector=new x(this.app,this.settings),this.backupManager=new R(this),this.undoManager=new T(this.app,this.settings)}registerCommands(){this.addCommand({id:"generate-images",name:"Generate Summary Images",callback:()=>this.generateImagesForCurrentNote()}),this.addCommand({id:"undo-injection",name:"Undo Last Image Injection",callback:()=>this.undoLastInjection()}),this.addCommand({id:"clear-all-images",name:"Remove All AI Images from Current Note",callback:()=>this.clearAllImages()}),this.addCommand({id:"show-backup",name:"Show Last Backup",callback:()=>this.showBackup()}),this.addCommand({id:"regenerate-image-at-cursor",name:"Regenerate Image at Cursor",editorCallback:e=>this.regenerateImageAtCursor(e)})}registerContextMenu(){this.registerEvent(this.app.workspace.on("editor-menu",(e,t,n)=>{let a=t.getCursor(),s=t.getValue(),i=this.findImageBlockAtCursor(s,a.line);i&&i.prompt&&e.addItem(r=>{r.setTitle("\u{1F504} Regenerate This Image").setIcon("refresh-cw").onClick(()=>{this.regenerateImageAtCursor(t)})})}))}async generateImagesForCurrentNote(){let e=this.app.workspace.getActiveFile();if(!e||e.extension!=="md"){new o.Notice("Please open a markdown note first");return}if(this.settings.connectionMode==="direct"){if(!this.settings.openaiApiKey||!this.settings.kieApiKey){new o.Notice("Please configure your API keys in settings");return}}else if(!this.settings.proxyToken){new o.Notice("Please configure your proxy token in settings");return}let t=new $(this.app);t.open();try{t.update({phase:"planning",currentItem:0,totalItems:0,message:"Reading note..."});let n=await this.app.vault.read(e),a=this.noteParser.parse(n);this.settings.createBackup&&await this.backupManager.save(e.path,n),t.update({phase:"planning",currentItem:0,totalItems:0,message:"Generating plan..."});let s=await this.apiClient.generatePlan(a,this.settings);console.log("Generated plan:",s);let i=s.items.length,r=[];for(let g=0;g<i;g++){let l=s.items[g];t.update({phase:"generating",currentItem:g+1,totalItems:i,message:`Generating image ${g+1}/${i}: ${l.title}`});try{let p=await this.apiClient.generateImage(l.prompt,this.settings,d=>{t.update({phase:"generating",currentItem:g+1,totalItems:i,message:`Image ${g+1}/${i}: ${d.message}`})});t.update({phase:"saving",currentItem:g+1,totalItems:i,message:`Saving image ${g+1}/${i}...`});let m=await this.imageInjector.saveImage(e,l.id,p);r.push({id:l.id,path:m,item:l,prompt:l.prompt})}catch(p){console.error(`Failed to generate image ${l.id}:`,p),new o.Notice(`Failed to generate image: ${l.title}`)}}r.length>0?(t.update({phase:"injecting",currentItem:r.length,totalItems:r.length,message:"Injecting images into note..."}),await this.imageInjector.injectImages(e,a,r),t.update({phase:"done",currentItem:r.length,totalItems:r.length,message:`Successfully generated ${r.length} images!`})):t.update({phase:"error",currentItem:0,totalItems:0,message:"No images were generated"})}catch(n){console.error("Generation failed:",n),t.update({phase:"error",currentItem:0,totalItems:0,message:`Error: ${n instanceof Error?n.message:"Unknown error"}`})}setTimeout(()=>t.close(),3e3)}async undoLastInjection(){let e=this.app.workspace.getActiveFile();if(!e){new o.Notice("Please open a note first");return}let t=await this.undoManager.undoLastInjection(e);t.success?new o.Notice(`Removed ${t.removedCount} images`):new o.Notice(t.message)}async regenerateImageAtCursor(e){let t=this.app.workspace.getActiveFile();if(!t){new o.Notice("Please open a note first");return}let n=e.getCursor(),a=e.getValue(),s=this.findImageBlockAtCursor(a,n.line);if(!s){new o.Notice("No AI image block found at cursor position");return}let{id:i,prompt:r,blockStart:g,blockEnd:l}=s;if(!r){new o.Notice("No prompt found in this image block. Cannot regenerate.");return}let p=new o.Notice("Regenerating image...",0);try{let m=await this.apiClient.generateImage(decodeURIComponent(r),this.settings,f=>{p.setMessage(`Regenerating: ${f.message}`)}),d=await this.imageInjector.saveImage(t,i,m),I=new Date().toISOString(),v=decodeURIComponent(r),k=[`<!-- ai-summary:start id="${i}" generated="${I}" prompt="${r}" -->`,`![[${d}]]`,"*Regenerated image*",`<!-- ai-summary:end id="${i}" -->`].join(`
`),h=a.split(`
`),y=[...h.slice(0,g),k,...h.slice(l+1)].join(`
`);e.setValue(y),p.hide(),new o.Notice("Image regenerated successfully!")}catch(m){p.hide(),console.error("Regeneration failed:",m),new o.Notice(`Failed to regenerate: ${m instanceof Error?m.message:"Unknown error"}`)}}findImageBlockAtCursor(e,t){let n=e.split(`
`),a=/<!-- ai-summary:start id="([^"]+)" generated="([^"]+)"(?: prompt="([^"]*)")? -->/,s=/<!-- ai-summary:end id="([^"]+)" -->/,i=-1,r="",g=null;for(let l=0;l<n.length;l++){let p=n[l].match(a);p&&(i=l,r=p[1],g=p[3]||null);let m=n[l].match(s);if(m&&m[1]===r){if(t>=i&&t<=l)return{id:r,prompt:g,blockStart:i,blockEnd:l};i=-1,r="",g=null}}return null}async clearAllImages(){let e=this.app.workspace.getActiveFile();if(!e){new o.Notice("Please open a note first");return}let t=await this.undoManager.clearAllImages(e);t.success?new o.Notice(`Removed ${t.removedCount} AI image blocks`):new o.Notice(t.message)}async showBackup(){let e=this.app.workspace.getActiveFile();if(!e){new o.Notice("Please open a note first");return}let t=await this.backupManager.getLatest(e.path);t?new O(this.app,t).open():new o.Notice("No backup found for this note")}async loadSettings(){this.settings=Object.assign({},K,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.initializeServices()}},D=class extends o.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Docs Summary to Image Settings"}),e.createEl("h3",{text:"Connection Mode"});let t,n;new o.Setting(e).setName("Connection Mode").setDesc("Choose how to connect to AI services").addDropdown(a=>a.addOption("direct","Direct API (Recommended)").addOption("proxy","Proxy Server (Advanced)").setValue(this.plugin.settings.connectionMode).onChange(async s=>{this.plugin.settings.connectionMode=s,await this.plugin.saveSettings(),this.display()})),t=e.createDiv(),t.createEl("h3",{text:"Direct API Settings"}),new o.Setting(t).setName("OpenAI API Key").setDesc("Get your key from OpenAI Platform (for plan generation)").addText(a=>(a.setPlaceholder("sk-...").setValue(this.plugin.settings.openaiApiKey).onChange(async s=>{this.plugin.settings.openaiApiKey=s,await this.plugin.saveSettings()}),a.inputEl.type="password",a)).addExtraButton(a=>a.setIcon("eye").setTooltip("Show/Hide API Key").onClick(()=>{var i;let s=(i=a.extraSettingsEl.parentElement)==null?void 0:i.querySelector("input");s&&(s.type=s.type==="password"?"text":"password",a.setIcon(s.type==="password"?"eye":"eye-off"))})),new o.Setting(t).setName("kie.ai API Key").setDesc("Get your key from kie.ai (for image generation)").addText(a=>(a.setPlaceholder("kie-...").setValue(this.plugin.settings.kieApiKey).onChange(async s=>{this.plugin.settings.kieApiKey=s,await this.plugin.saveSettings()}),a.inputEl.type="password",a)).addExtraButton(a=>a.setIcon("eye").setTooltip("Show/Hide API Key").onClick(()=>{var i;let s=(i=a.extraSettingsEl.parentElement)==null?void 0:i.querySelector("input");s&&(s.type=s.type==="password"?"text":"password",a.setIcon(s.type==="password"?"eye":"eye-off"))})),n=e.createDiv(),n.createEl("h3",{text:"Proxy Server Settings"}),new o.Setting(n).setName("Proxy URL").setDesc("URL of the Gemini image proxy server").addText(a=>a.setPlaceholder("https://...").setValue(this.plugin.settings.proxyUrl).onChange(async s=>{this.plugin.settings.proxyUrl=s,await this.plugin.saveSettings()})),new o.Setting(n).setName("Proxy Token").setDesc("Your authentication token for the proxy server").addText(a=>(a.setPlaceholder("ogsip_...").setValue(this.plugin.settings.proxyToken).onChange(async s=>{this.plugin.settings.proxyToken=s,await this.plugin.saveSettings()}),a.inputEl.type="password",a)).addExtraButton(a=>a.setIcon("eye").setTooltip("Show/Hide Token").onClick(()=>{var i;let s=(i=a.extraSettingsEl.parentElement)==null?void 0:i.querySelector("input");s&&(s.type=s.type==="password"?"text":"password",a.setIcon(s.type==="password"?"eye":"eye-off"))})),this.plugin.settings.connectionMode==="direct"?n.style.display="none":t.style.display="none",e.createEl("h3",{text:"Generation"}),new o.Setting(e).setName("Max Image Count").setDesc("Maximum number of images to generate (actual count depends on headings)").addSlider(a=>a.setLimits(1,8,1).setValue(this.plugin.settings.maxImageCount).setDynamicTooltip().onChange(async s=>{this.plugin.settings.maxImageCount=s,await this.plugin.saveSettings()})),new o.Setting(e).setName("Image Style").setDesc("Visual style for generated images").addDropdown(a=>a.addOption("infographic","Infographic").addOption("diagram","Diagram").addOption("card","Summary Card").addOption("whiteboard","Whiteboard").addOption("slide","Slide").setValue(this.plugin.settings.imageStyle).onChange(async s=>{this.plugin.settings.imageStyle=s,await this.plugin.saveSettings()})),new o.Setting(e).setName("Aspect Ratio").setDesc("Aspect ratio for generated images").addDropdown(a=>a.addOption("16:9","16:9 (Widescreen)").addOption("4:3","4:3 (Standard)").addOption("1:1","1:1 (Square)").setValue(this.plugin.settings.aspectRatio).onChange(async s=>{this.plugin.settings.aspectRatio=s,await this.plugin.saveSettings()})),new o.Setting(e).setName("Resolution").setDesc("Image resolution (4K costs more credits)").addDropdown(a=>a.addOption("1K","1K").addOption("2K","2K").addOption("4K","4K \u26A0\uFE0F High Price").setValue(this.plugin.settings.resolution).onChange(async s=>{this.plugin.settings.resolution=s,await this.plugin.saveSettings()})),new o.Setting(e).setName("Language").setDesc("Language for image titles and descriptions").addDropdown(a=>a.addOption("ja","Japanese").addOption("en","English").setValue(this.plugin.settings.language).onChange(async s=>{this.plugin.settings.language=s,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Storage"}),new o.Setting(e).setName("Attachment Folder").setDesc("Folder to save generated images (relative to vault root)").addText(a=>a.setPlaceholder("attachments/ai-summary").setValue(this.plugin.settings.attachmentFolder).onChange(async s=>{this.plugin.settings.attachmentFolder=s,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Content Processing"}),new o.Setting(e).setName("Send Mode").setDesc("How much of the note to send to the AI").addDropdown(a=>a.addOption("full","Full content").addOption("headings","Headings + excerpts").addOption("summary","Summary only").setValue(this.plugin.settings.sendMode).onChange(async s=>{this.plugin.settings.sendMode=s,await this.plugin.saveSettings()})),new o.Setting(e).setName("Max Characters").setDesc("Maximum characters to send (for token optimization)").addText(a=>a.setPlaceholder("30000").setValue(String(this.plugin.settings.maxCharacters)).onChange(async s=>{let i=parseInt(s);!isNaN(i)&&i>0&&(this.plugin.settings.maxCharacters=i,await this.plugin.saveSettings())})),e.createEl("h3",{text:"Safety"}),new o.Setting(e).setName("Create Backup").setDesc("Save a backup of the note before injecting images").addToggle(a=>a.setValue(this.plugin.settings.createBackup).onChange(async s=>{this.plugin.settings.createBackup=s,await this.plugin.saveSettings()})),new o.Setting(e).setName("Backup Location").setDesc("Where to store backups").addDropdown(a=>a.addOption("plugin","Plugin data (lightweight)").addOption("vault","Vault folder (robust)").setValue(this.plugin.settings.backupLocation).onChange(async s=>{this.plugin.settings.backupLocation=s,await this.plugin.saveSettings()}))}},O=class extends o.Modal{constructor(e,t){super(e),this.backup=t}onOpen(){let{contentEl:e}=this;e.createEl("h2",{text:"Backup Content"}),e.createEl("p",{text:`Saved at: ${new Date(this.backup.timestamp).toLocaleString()}`});let t=e.createEl("textarea",{attr:{style:"width: 100%; height: 400px; font-family: monospace;",readonly:"true"}});t.value=this.backup.originalContent,new o.Setting(e).addButton(n=>n.setButtonText("Close").onClick(()=>this.close()))}onClose(){this.contentEl.empty()}};
