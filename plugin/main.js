var M=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var V=Object.getOwnPropertyNames;var J=Object.prototype.hasOwnProperty;var W=(l,e)=>{for(var t in e)M(l,t,{get:e[t],enumerable:!0})},X=(l,e,t,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of V(e))!J.call(l,n)&&n!==t&&M(l,n,{get:()=>e[n],enumerable:!(a=z(e,n))||a.enumerable});return l};var Y=l=>X(M({},"__esModule",{value:!0}),l);var Q={};W(Q,{default:()=>R});module.exports=Y(Q);var o=require("obsidian");var L={connectionMode:"direct",geminiApiKey:"",openaiApiKey:"",kieApiKey:"",proxyUrl:"https://gemini-image-proxy.your-domain.workers.dev",proxyToken:"",maxImageCount:8,imageStyle:"infographic",aspectRatio:"16:9",resolution:"1K",language:"ja",attachmentFolder:"attachments/ai-summary",sendMode:"headings",maxCharacters:3e4,createBackup:!0,backupLocation:"plugin"},h={START:(l,e)=>`<!-- ai-summary:start id="${l}" generated="${e}" -->`,END:l=>`<!-- ai-summary:end id="${l}" -->`,REGEX:{BLOCK:/<!-- ai-summary:start id="([^"]+)"[^>]*-->[\s\S]*?<!-- ai-summary:end id="\1" -->\n?/g,START:/<!-- ai-summary:start id="([^"]+)" generated="([^"]+)" -->/}};var S=require("obsidian"),v=class{constructor(e){this.openaiApiKey=e.openaiApiKey,this.kieApiKey=e.kieApiKey}async generatePlan(e,t){var i,r;if(!this.openaiApiKey)throw new Error("OpenAI API key is required");let a=this.compressContent(e,t.maxCharacters),n=`\u3042\u306A\u305F\u306F\u753B\u50CF\u751F\u6210\u30D7\u30E9\u30F3\u3092\u4F5C\u6210\u3059\u308B\u30A8\u30AD\u30B9\u30D1\u30FC\u30C8\u3067\u3059\u3002\u4EE5\u4E0B\u306E\u6307\u793A\u306B\u5F93\u3063\u3066\u3001\u30CE\u30FC\u30C8\u8A18\u4E8B\u306E\u5185\u5BB9\u3092\u8981\u7D04\u3057\u3001\u898B\u51FA\u3057\u306E\u6570\u3060\u3051\u753B\u50CF\u751F\u6210\u30D7\u30E9\u30F3\u3092\u4F5C\u6210\u3057\u3066\u304F\u3060\u3055\u3044\uFF08\u6700\u5927${t.maxImageCount}\u679A\u307E\u3067\uFF09\u3002

## Liquid Glass (Apple-like) + List Infographic Style (16:9)

### Visual Theme (Liquid Glass)
- Use translucent frosted-glass panels (layered cards) with soft blur, subtle refraction feel, and specular highlights.
- Glass panels should feel "tinted" by accent colors, but keep high legibility and ample whitespace.

### Recommended Color Palette (Apple System Colors as Liquid Glass tints)
- Base / Background:
  - Light neutral background: #F2F2F7 (soft gray-white)
  - Primary text: #000000
  - Separator / hairline: rgba(120,120,128,0.20)
- Accent tints (use 1\u20132 per slide, do NOT rainbow everything):
  - systemTeal:   #5AC8FA
  - systemBlue:   #007AFF
  - systemIndigo: #5856D6
  - systemPurple: #AF52DE
  - systemPink:   #FF2D55
  - Optional for emphasis only:
    - systemGreen:  #34C759
    - systemOrange: #FF9500
    - systemYellow: #FFCC00
    - systemRed:    #FF3B30
- If you use gradients, prefer "teal \u2192 blue \u2192 purple" as the main Liquid Glass gradient accent.

### Layout Rule (List-style Infographic)
- Each slide must be a LIST infographic:
  - Vertical stack of 4\u20137 items (cards or rows).
  - Each item: icon/bullet \u2192 short label \u2192 optional micro-sublabel (very short).
  - Use consistent spacing, alignment, and repeating rhythm (grid).
- Allow variants across images while staying list-based:
  - numbered list, checklist, steps list, pros/cons list, timeline-as-list, glossary list.

### Typography (M PLUS 1)
- Use "M PLUS 1" for all text (title, labels, captions).
- Minimum font size: 24px (no small text).
- Keep text minimal: short labels only (3\u20136 words max per label). Avoid paragraphs.

### Shape & Components
- Rounded corners everywhere (cards, pills, chips): large radius (16\u201324px).
- Use subtle shadows, soft inner highlights on glass cards, and consistent icon stroke weight.

### Quality / Negative Constraints
- No dense text blocks, no tiny legends, no screenshots, no watermarks/logos.
- Prioritize clarity: strong contrast between text and glass surface.

\u5FC5\u305A\u4EE5\u4E0B\u306EJSON\u5F62\u5F0F\u306E\u307F\u3067\u51FA\u529B\u3057\u3066\u304F\u3060\u3055\u3044\u3002\u8AAC\u660E\u6587\u306F\u4E0D\u8981\u3067\u3059\u3002
{
  "items": [
    {
      "id": "img1",
      "title": "\u753B\u50CF\u306E\u30BF\u30A4\u30C8\u30EB",
      "afterHeading": "\u633F\u5165\u4F4D\u7F6E\u306E\u898B\u51FA\u3057\uFF08\u30CE\u30FC\u30C8\u5185\u306E\u5B9F\u969B\u306E\u898B\u51FA\u3057\u30C6\u30AD\u30B9\u30C8\uFF09",
      "prompt": "\u753B\u50CF\u751F\u6210\u30D7\u30ED\u30F3\u30D7\u30C8\uFF08${t.imageStyle}\u30B9\u30BF\u30A4\u30EB\u3001${t.language}\u8A00\u8A9E\u3001\u4E0A\u8A18Liquid Glass\u30B9\u30BF\u30A4\u30EB\u6307\u793A\u3092\u542B\u3080\u8A73\u7D30\u306A\u30D7\u30ED\u30F3\u30D7\u30C8\uFF09",
      "description": "\u753B\u50CF\u306E\u8AAC\u660E"
    }
  ]
}`,s=`\u4EE5\u4E0B\u306E\u30CE\u30FC\u30C8\u8A18\u4E8B\u306E\u5185\u5BB9\u3092\u6700\u521D\u304B\u3089\u6700\u5F8C\u307E\u3067\u719F\u8AAD\u3057\u3001\u305D\u306E\u5185\u5BB9\u3092\u8981\u7D04\u3057\u305F\u3046\u3048\u3067\u3001\u898B\u51FA\u3057\u306E\u6570\u3060\u3051\u753B\u50CF\u751F\u6210\u30D7\u30E9\u30F3\u3092\u4F5C\u6210\u3057\u3066\u304F\u3060\u3055\u3044\u3002

\u30CE\u30FC\u30C8\u5185\u5BB9:
${a}`;try{let g={model:"gpt-5-mini-2025-08-07",messages:[{role:"system",content:n},{role:"user",content:s}],max_completion_tokens:16384,response_format:{type:"json_object"}};console.log("\uFFFD OpenAI API: Generating plan...");let c=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.openaiApiKey}`},body:JSON.stringify(g)}),p=await c.json();if(!c.ok)throw console.error("\u274C OpenAI API error:",(i=p==null?void 0:p.error)==null?void 0:i.message),new Error(`OpenAI API error: ${c.status} - ${((r=p==null?void 0:p.error)==null?void 0:r.message)||JSON.stringify(p)}`);let u=p.choices[0].message.content;if(!u||u.trim()==="")throw console.error("\u274C Empty response from OpenAI"),new Error("OpenAI returned empty response. Try again.");return console.log("\u2705 OpenAI API: Plan generated successfully"),{version:"1",items:JSON.parse(u).items||[],metadata:{noteHash:this.computeHash(e.rawContent),generatedAt:new Date().toISOString()}}}catch(g){throw g instanceof Error?g:new Error(`Failed to generate plan: ${g}`)}}async generateImage(e,t,a){var n,s,i,r,g;if(!this.kieApiKey)throw new Error("kie.ai API key is required");a==null||a({status:"creating",message:"Creating image generation task..."}),console.log("\u{1F3A8} kie.ai: Creating image task...");try{let c=await(0,S.requestUrl)({url:"https://api.kie.ai/api/v1/jobs/createTask",method:"POST",headers:{Authorization:`Bearer ${this.kieApiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:"nano-banana-pro",input:{prompt:e,aspect_ratio:t.aspectRatio||"1:1",resolution:t.resolution||"1K",output_format:"png"}})});if(c.status>=400)throw new Error(`kie.ai API error: ${c.status}`);let p=c.json,u=((n=p.data)==null?void 0:n.taskId)||p.taskId;if(!u)throw new Error("No job_id in response");console.log("\u{1F3A8} kie.ai: Task created, polling for result..."),a==null||a({status:"generating",message:"Generating image..."});let d=0,T=60;for(await new Promise(N=>setTimeout(N,2e3));d<T;){await new Promise(w=>setTimeout(w,5e3));let N=`https://api.kie.ai/api/v1/jobs/recordInfo?taskId=${u}`,$=await(0,S.requestUrl)({url:N,method:"GET",headers:{Authorization:`Bearer ${this.kieApiKey}`}});if($.status>=400)throw new Error(`Failed to check status: ${$.status}`);let y=$.json;if(y.code===200&&((s=y.data)==null?void 0:s.state)==="success"){let w=[];if((i=y.data)!=null&&i.resultJson)try{w=JSON.parse(y.data.resultJson).resultUrls||[]}catch(f){console.error("Failed to parse resultJson:",f)}if(w.length>0){a==null||a({status:"downloading",message:"Downloading image..."});let f=await(0,S.requestUrl)({url:w[0],method:"GET"});if(f.status>=400)throw new Error(`Failed to download image: ${f.status}`);return console.log("\u2705 kie.ai: Image generated successfully"),f.arrayBuffer}}if(((r=y.data)==null?void 0:r.state)==="fail")throw console.error("\u274C kie.ai: Image generation failed"),new Error(`Image generation failed: ${((g=y.data)==null?void 0:g.failMsg)||"Unknown error"}`);d++,a==null||a({status:"generating",message:`Generating image... (${d}/${T})`,progress:d/T*100})}throw new Error("Image generation timed out")}catch(c){throw c instanceof Error?c:new Error(`Failed to generate image: ${c}`)}}enhancePrompt(e,t){let a={infographic:{prefix:"Create a modern infographic visualization.",suffix:"Use flat design, data-driven icons, clean color palette. Professional infographic style."},diagram:{prefix:"Create a clear conceptual diagram.",suffix:"Use geometric shapes, connecting arrows, hierarchical layout. Minimal diagram style."},card:{prefix:"Create a summary card design.",suffix:"Use bold visual hierarchy, icon grid, gradient background. Modern UI card style."},whiteboard:{prefix:"Create a hand-drawn whiteboard sketch.",suffix:"Use loose sketchy lines, warm colors, informal doodle style. Educational whiteboard feel."},slide:{prefix:"Create a professional presentation slide design.",suffix:"Use corporate color scheme, structured layout, subtle gradients. Business slide style."}},n=a[t]||a.infographic;return`${n.prefix}

${e}

${n.suffix}`}compressContent(e,t){let a=e.rawContent;if(a=a.replace(/^---[\s\S]*?---\n/,""),a=a.replace(/```(\w+)?\n[\s\S]*?```/g,(n,s)=>`[code block: ${s||"code"}]`),a.length>t){let n=Math.floor(t/e.sections.length);a=e.sections.map(s=>{let i=s.content.slice(0,n);return`${s.heading}
${i}${s.content.length>n?"...":""}`}).join(`

`)}return a.length>t&&(a=a.slice(0,t)+`

[truncated]`),a}computeHash(e){let t=0;if(e.length===0)return t.toString(16);for(let a=0;a<e.length;a++){let n=e.charCodeAt(a);t=(t<<5)-t+n,t=t&t}return Math.abs(t).toString(16)}};var k=require("obsidian"),U=5e3,K=60,A=class{constructor(e){this.baseUrl=e.proxyUrl.replace(/\/$/,""),this.token=e.proxyToken}async generatePlan(e,t){let n={noteContent:this.compressContent(e,t.maxCharacters),settings:{imageCount:t.maxImageCount,style:t.imageStyle,language:t.language}};return await this.post("/v1/plan",n)}async generateImage(e,t,a){a==null||a({status:"creating",message:"Creating image task..."});let n={prompt:e,style:t.imageStyle,aspectRatio:t.aspectRatio,resolution:t.resolution||"1K",outputFormat:"png"},s=await this.post("/v1/image/create",n),{jobId:i}=s,r=await this.pollForCompletion(i,a);return a==null||a({status:"downloading",message:"Downloading image..."}),await this.downloadImage(r)}async pollForCompletion(e,t){for(let a=0;a<K;a++){let n=await this.get(`/v1/image/status/${e}`);if(t==null||t({status:n.status,message:this.getStatusMessage(n.status),progress:n.progress}),n.status==="completed"){if(!n.imageUrl)throw new m("GENERATION_FAILED","No image URL in completed response");return n.imageUrl}if(n.status==="failed")throw new m("GENERATION_FAILED",n.errorMessage||"Image generation failed");await this.sleep(U)}throw new m("TIMEOUT",`Image generation timed out after ${K*U/1e3} seconds`)}async downloadImage(e){try{let t=await(0,k.requestUrl)({url:e,method:"GET"});if(t.status>=400)throw new m("GENERATION_FAILED",`Failed to download image: ${t.status}`);return t.arrayBuffer}catch(t){throw t instanceof m?t:new m("NETWORK_ERROR",`Failed to download image: ${t}`)}}getStatusMessage(e){switch(e){case"pending":return"Waiting in queue...";case"processing":return"Generating image...";case"completed":return"Image generated!";case"failed":return"Generation failed";default:return`Status: ${e}`}}compressContent(e,t){let a=e.rawContent;if(a=a.replace(/^---[\s\S]*?---\n/,""),a=a.replace(/```(\w+)?\n[\s\S]*?```/g,(n,s)=>`[code block: ${s||"code"}]`),a.length>t){let n=Math.floor(t/e.sections.length);a=e.sections.map(s=>{let i=s.content.slice(0,n);return`${s.heading}
${i}${s.content.length>n?"...":""}`}).join(`

`)}return a.length>t&&(a=a.slice(0,t)+`

[truncated]`),a}async get(e){let t=`${this.baseUrl}${e}`;try{let a=await(0,k.requestUrl)({url:t,method:"GET",headers:{Authorization:`Bearer ${this.token}`}});if(a.status>=400)throw this.handleErrorResponse(a);return a.json}catch(a){throw a instanceof m?a:new m("NETWORK_ERROR",`Network error: ${a}`)}}async post(e,t){let a=`${this.baseUrl}${e}`;try{let n=await(0,k.requestUrl)({url:a,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify(t)});if(n.status>=400)throw this.handleErrorResponse(n);return n.json}catch(n){throw n instanceof m?n:new m("NETWORK_ERROR",`Network error: ${n}`)}}handleErrorResponse(e){try{let t=e.json;return new m(t.error.code,t.error.message,t.error.retryable,t.error.retryAfter)}catch(t){return new m("UNKNOWN_ERROR",`HTTP ${e.status}: ${e.text||"Unknown error"}`)}}sleep(e){return new Promise(t=>setTimeout(t,e))}},m=class extends Error{constructor(t,a,n=!1,s){super(a);this.code=t;this.retryable=n;this.retryAfter=s;this.name="ProxyError"}};function G(l){switch(l.connectionMode){case"direct":return new v(l);case"proxy":return new A(l);default:throw new Error(`Unknown connection mode: ${l.connectionMode}`)}}var b=class{parse(e){let t=this.extractFrontmatter(e),a=this.removeFrontmatter(e),n=this.extractSections(a);return{frontmatter:t,sections:n,rawContent:e}}extractFrontmatter(e){let t=e.match(/^---\n([\s\S]*?)\n---/);return t?t[1]:null}removeFrontmatter(e){return e.replace(/^---\n[\s\S]*?\n---\n/,"")}extractSections(e){let t=e.split(`
`),a=[],n=null;for(let s=0;s<t.length;s++){let i=t[s],r=i.match(/^(#{1,6})\s+(.+)$/);r?(n&&(n.lineEnd=s-1,a.push(n)),n={heading:i,level:r[1].length,content:"",lineStart:s,lineEnd:s}):n?n.content+=(n.content?`
`:"")+i:i.trim()&&!n&&(n={heading:"",level:0,content:i,lineStart:s,lineEnd:s})}return n&&(n.lineEnd=t.length-1,a.push(n)),a}getHeadingsList(e){return e.sections.filter(t=>t.heading).map(t=>t.heading)}findHeadingLine(e,t){let a=e.sections.find(n=>n.heading===t);return a?a.lineStart:null}};var I=require("obsidian");function F(l){let e=0;if(l.length===0)return e.toString(16);for(let t=0;t<l.length;t++){let a=l.charCodeAt(t);e=(e<<5)-e+a,e=e&e}return Math.abs(e).toString(16)}function _(l){let e=l.replace(/[<>:"/\\|?*]/g,"-").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"");return e.length>100&&(e=e.slice(0,100)),e||(e="unnamed"),e}var E=class{constructor(e,t){this.lastReadHash=null;this.app=e,this.settings=t}async saveImage(e,t,a){let n=(0,I.normalizePath)(this.settings.attachmentFolder);await this.ensureFolder(n);let i=`${_(e.basename)}__${t}.png`,r=(0,I.normalizePath)(`${n}/${i}`),g=this.app.vault.getAbstractFileByPath(r);return g instanceof I.TFile&&await this.app.vault.delete(g),await this.app.vault.adapter.writeBinary(r,a),r}async injectImages(e,t,a){let n=await this.app.vault.read(e),s=F(n);if(this.lastReadHash&&this.lastReadHash!==s)throw new Error("Note was modified externally. Please try again.");let i=this.calculateInsertions(t,a);i.sort((c,p)=>p.lineNumber-c.lineNumber);let r=n.split(`
`);for(let c of i){let p=this.createImageBlock(c.image);r.splice(c.lineNumber+1,0,p)}let g=r.join(`
`);await this.app.vault.modify(e,g)}calculateInsertions(e,t){let a=[];for(let n of t){let{afterHeading:s}=n.item,i=-1;for(let r of e.sections)if(r.heading===s||r.heading.includes(s)){i=r.lineStart;break}if(i===-1){let r=e.sections[e.sections.length-1];i=r?r.lineEnd:0}a.push({lineNumber:i,image:n})}return a}createImageBlock(e){let t=new Date().toISOString(),{id:a,path:n,item:s}=e;return["",h.START(a,t),`![[${n}]]`,`*${s.title}: ${s.description}*`,h.END(a),""].join(`
`)}async ensureFolder(e){this.app.vault.getAbstractFileByPath(e)||await this.app.vault.createFolder(e)}setLastReadHash(e){this.lastReadHash=F(e)}};var j="backups",x=class{constructor(e){this.plugin=e}async save(e,t){let a=await this.getStorage(),n={noteId:e,originalContent:t,timestamp:Date.now(),injectedImages:[]};a.backups=a.backups.filter(s=>s.noteId!==e),a.backups.unshift(n),a.backups.length>5&&(a.backups=a.backups.slice(0,5)),await this.saveStorage(a)}async recordInjectedImage(e,t){let a=await this.getStorage(),n=a.backups.find(s=>s.noteId===e);n&&(n.injectedImages.push(t),await this.saveStorage(a))}async getLatest(e){return(await this.getStorage()).backups.find(a=>a.noteId===e)||null}async getAll(){return(await this.getStorage()).backups}async remove(e){let t=await this.getStorage();t.backups=t.backups.filter(a=>a.noteId!==e),await this.saveStorage(t)}async getStorage(){let e=await this.plugin.loadData();return(e==null?void 0:e[j])||{backups:[]}}async saveStorage(e){let t=await this.plugin.loadData()||{};t[j]=e,await this.plugin.saveData(t)}};var H=require("obsidian");var P=class{constructor(e,t){this.app=e,this.settings=t}async undoLastInjection(e){let t=await this.app.vault.read(e),a=this.findAllBlocks(t);if(a.length===0)return{success:!1,message:"No AI image blocks found in this note",removedCount:0};let n=Math.max(...a.map(r=>r.timestamp)),s=a.filter(r=>r.timestamp===n),i=t;for(let r of s)i=i.replace(r.fullMatch,"");return i=i.replace(/\n{3,}/g,`

`),await this.app.vault.modify(e,i),await this.removeImageFiles(s),{success:!0,message:`Removed ${s.length} image blocks`,removedCount:s.length}}async clearAllImages(e){let t=await this.app.vault.read(e),a=this.findAllBlocks(t);if(a.length===0)return{success:!1,message:"No AI image blocks found in this note",removedCount:0};let n=t.replace(h.REGEX.BLOCK,"");return n=n.replace(/\n{3,}/g,`

`),await this.app.vault.modify(e,n),await this.removeImageFiles(a),{success:!0,message:`Removed ${a.length} image blocks`,removedCount:a.length}}findAllBlocks(e){let t=[],a,n=new RegExp(h.REGEX.BLOCK.source,"g");for(;(a=n.exec(e))!==null;){let s=a[0],i=a[1],r=s.match(h.REGEX.START),g=r!=null&&r[2]?new Date(r[2]).getTime():0,c=s.match(/!\[\[([^\]]+)\]\]/),p=c?c[1]:null;t.push({id:i,timestamp:g,fullMatch:s,imagePath:p})}return t}async removeImageFiles(e){for(let t of e)if(t.imagePath){let a=this.app.vault.getAbstractFileByPath(t.imagePath);if(a instanceof H.TFile)try{await this.app.vault.delete(a)}catch(n){console.warn(`Failed to delete image file: ${t.imagePath}`,n)}}}};var q=require("obsidian"),B=["\u{1F34C} generating banana...","\u{1F34C}. generating banana...","\u{1F34C}.. generating banana...","\u{1F34C}... generating banana...","\u{1F34C}.... generating banana...","\u{1F34C}..... generating banana..."];var C=class extends q.Modal{constructor(t){super(t);this.progressEl=null;this.messageEl=null;this.barEl=null;this.animationEl=null;this.animationInterval=null;this.frameIndex=0}onOpen(){let{contentEl:t}=this;t.addClass("docs-summary-progress-modal"),this.animationEl=t.createEl("pre",{cls:"banana-animation"}),this.animationEl.setText(B[0]),this.startAnimation(),t.createEl("h2",{text:"\u{1F34C} Generating Banana Images"});let a=t.createDiv({cls:"progress-bar-container"});this.barEl=a.createDiv({cls:"progress-bar"}),this.barEl.style.width="0%",this.messageEl=t.createEl("p",{cls:"progress-message"}),this.messageEl.setText("Initializing..."),this.progressEl=t.createEl("p",{cls:"progress-status"})}onClose(){this.stopAnimation(),this.contentEl.empty()}startAnimation(){this.animationInterval=window.setInterval(()=>{this.frameIndex=(this.frameIndex+1)%B.length,this.animationEl&&this.animationEl.setText(B[this.frameIndex])},300)}stopAnimation(){this.animationInterval!==null&&(window.clearInterval(this.animationInterval),this.animationInterval=null)}update(t){if(this.messageEl&&this.messageEl.setText(t.message),this.progressEl&&t.totalItems>0&&this.progressEl.setText(`${t.currentItem} / ${t.totalItems}`),this.barEl&&t.totalItems>0){let a=t.currentItem/t.totalItems*100;this.barEl.style.width=`${a}%`}this.contentEl.removeClass("phase-planning","phase-generating","phase-done","phase-error"),this.contentEl.addClass(`phase-${t.phase}`),(t.phase==="done"||t.phase==="error")&&(this.stopAnimation(),this.animationEl&&this.animationEl.setText(t.phase==="done"?"\u{1F34C} Done!":"\u274C Error"))}};var R=class extends o.Plugin{async onload(){await this.loadSettings(),this.initializeServices(),this.registerCommands(),this.addSettingTab(new D(this.app,this)),console.log("Gemini Summary Images Plugin loaded")}onunload(){console.log("Gemini Summary Images Plugin unloaded")}initializeServices(){this.apiClient=G(this.settings),this.noteParser=new b,this.imageInjector=new E(this.app,this.settings),this.backupManager=new x(this),this.undoManager=new P(this.app,this.settings)}registerCommands(){this.addCommand({id:"generate-images",name:"Generate Summary Images",callback:()=>this.generateImagesForCurrentNote()}),this.addCommand({id:"undo-injection",name:"Undo Last Image Injection",callback:()=>this.undoLastInjection()}),this.addCommand({id:"clear-all-images",name:"Remove All AI Images from Current Note",callback:()=>this.clearAllImages()}),this.addCommand({id:"show-backup",name:"Show Last Backup",callback:()=>this.showBackup()})}async generateImagesForCurrentNote(){let e=this.app.workspace.getActiveFile();if(!e||e.extension!=="md"){new o.Notice("Please open a markdown note first");return}if(this.settings.connectionMode==="direct"){if(!this.settings.openaiApiKey||!this.settings.kieApiKey){new o.Notice("Please configure your API keys in settings");return}}else if(!this.settings.proxyToken){new o.Notice("Please configure your proxy token in settings");return}let t=new C(this.app);t.open();try{t.update({phase:"planning",currentItem:0,totalItems:0,message:"Reading note..."});let a=await this.app.vault.read(e),n=this.noteParser.parse(a);this.settings.createBackup&&await this.backupManager.save(e.path,a),t.update({phase:"planning",currentItem:0,totalItems:0,message:"Generating plan..."});let s=await this.apiClient.generatePlan(n,this.settings);console.log("Generated plan:",s);let i=s.items.length,r=[];for(let g=0;g<i;g++){let c=s.items[g];t.update({phase:"generating",currentItem:g+1,totalItems:i,message:`Generating image ${g+1}/${i}: ${c.title}`});try{let p=await this.apiClient.generateImage(c.prompt,this.settings,d=>{t.update({phase:"generating",currentItem:g+1,totalItems:i,message:`Image ${g+1}/${i}: ${d.message}`})});t.update({phase:"saving",currentItem:g+1,totalItems:i,message:`Saving image ${g+1}/${i}...`});let u=await this.imageInjector.saveImage(e,c.id,p);r.push({id:c.id,path:u,item:c})}catch(p){console.error(`Failed to generate image ${c.id}:`,p),new o.Notice(`Failed to generate image: ${c.title}`)}}r.length>0?(t.update({phase:"injecting",currentItem:r.length,totalItems:r.length,message:"Injecting images into note..."}),await this.imageInjector.injectImages(e,n,r),t.update({phase:"done",currentItem:r.length,totalItems:r.length,message:`Successfully generated ${r.length} images!`})):t.update({phase:"error",currentItem:0,totalItems:0,message:"No images were generated"})}catch(a){console.error("Generation failed:",a),t.update({phase:"error",currentItem:0,totalItems:0,message:`Error: ${a instanceof Error?a.message:"Unknown error"}`})}setTimeout(()=>t.close(),3e3)}async undoLastInjection(){let e=this.app.workspace.getActiveFile();if(!e){new o.Notice("Please open a note first");return}let t=await this.undoManager.undoLastInjection(e);t.success?new o.Notice(`Removed ${t.removedCount} images`):new o.Notice(t.message)}async clearAllImages(){let e=this.app.workspace.getActiveFile();if(!e){new o.Notice("Please open a note first");return}let t=await this.undoManager.clearAllImages(e);t.success?new o.Notice(`Removed ${t.removedCount} AI image blocks`):new o.Notice(t.message)}async showBackup(){let e=this.app.workspace.getActiveFile();if(!e){new o.Notice("Please open a note first");return}let t=await this.backupManager.getLatest(e.path);t?new O(this.app,t).open():new o.Notice("No backup found for this note")}async loadSettings(){this.settings=Object.assign({},L,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.initializeServices()}},D=class extends o.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Docs Summary to Image Settings"}),e.createEl("h3",{text:"Connection Mode"});let t,a;new o.Setting(e).setName("Connection Mode").setDesc("Choose how to connect to AI services").addDropdown(n=>n.addOption("direct","Direct API (Recommended)").addOption("proxy","Proxy Server (Advanced)").setValue(this.plugin.settings.connectionMode).onChange(async s=>{this.plugin.settings.connectionMode=s,await this.plugin.saveSettings(),this.display()})),t=e.createDiv(),t.createEl("h3",{text:"Direct API Settings"}),new o.Setting(t).setName("OpenAI API Key").setDesc("Get your key from OpenAI Platform (for plan generation)").addText(n=>(n.setPlaceholder("sk-...").setValue(this.plugin.settings.openaiApiKey).onChange(async s=>{this.plugin.settings.openaiApiKey=s,await this.plugin.saveSettings()}),n.inputEl.type="password",n)).addExtraButton(n=>n.setIcon("eye").setTooltip("Show/Hide API Key").onClick(()=>{var i;let s=(i=n.extraSettingsEl.parentElement)==null?void 0:i.querySelector("input");s&&(s.type=s.type==="password"?"text":"password",n.setIcon(s.type==="password"?"eye":"eye-off"))})),new o.Setting(t).setName("kie.ai API Key").setDesc("Get your key from kie.ai (for image generation)").addText(n=>(n.setPlaceholder("kie-...").setValue(this.plugin.settings.kieApiKey).onChange(async s=>{this.plugin.settings.kieApiKey=s,await this.plugin.saveSettings()}),n.inputEl.type="password",n)).addExtraButton(n=>n.setIcon("eye").setTooltip("Show/Hide API Key").onClick(()=>{var i;let s=(i=n.extraSettingsEl.parentElement)==null?void 0:i.querySelector("input");s&&(s.type=s.type==="password"?"text":"password",n.setIcon(s.type==="password"?"eye":"eye-off"))})),a=e.createDiv(),a.createEl("h3",{text:"Proxy Server Settings"}),new o.Setting(a).setName("Proxy URL").setDesc("URL of the Gemini image proxy server").addText(n=>n.setPlaceholder("https://...").setValue(this.plugin.settings.proxyUrl).onChange(async s=>{this.plugin.settings.proxyUrl=s,await this.plugin.saveSettings()})),new o.Setting(a).setName("Proxy Token").setDesc("Your authentication token for the proxy server").addText(n=>(n.setPlaceholder("ogsip_...").setValue(this.plugin.settings.proxyToken).onChange(async s=>{this.plugin.settings.proxyToken=s,await this.plugin.saveSettings()}),n.inputEl.type="password",n)).addExtraButton(n=>n.setIcon("eye").setTooltip("Show/Hide Token").onClick(()=>{var i;let s=(i=n.extraSettingsEl.parentElement)==null?void 0:i.querySelector("input");s&&(s.type=s.type==="password"?"text":"password",n.setIcon(s.type==="password"?"eye":"eye-off"))})),this.plugin.settings.connectionMode==="direct"?a.style.display="none":t.style.display="none",e.createEl("h3",{text:"Generation"}),new o.Setting(e).setName("Max Image Count").setDesc("Maximum number of images to generate (actual count depends on headings)").addSlider(n=>n.setLimits(1,8,1).setValue(this.plugin.settings.maxImageCount).setDynamicTooltip().onChange(async s=>{this.plugin.settings.maxImageCount=s,await this.plugin.saveSettings()})),new o.Setting(e).setName("Image Style").setDesc("Visual style for generated images").addDropdown(n=>n.addOption("infographic","Infographic").addOption("diagram","Diagram").addOption("card","Summary Card").addOption("whiteboard","Whiteboard").addOption("slide","Slide").setValue(this.plugin.settings.imageStyle).onChange(async s=>{this.plugin.settings.imageStyle=s,await this.plugin.saveSettings()})),new o.Setting(e).setName("Aspect Ratio").setDesc("Aspect ratio for generated images").addDropdown(n=>n.addOption("16:9","16:9 (Widescreen)").addOption("4:3","4:3 (Standard)").addOption("1:1","1:1 (Square)").setValue(this.plugin.settings.aspectRatio).onChange(async s=>{this.plugin.settings.aspectRatio=s,await this.plugin.saveSettings()})),new o.Setting(e).setName("Resolution").setDesc("Image resolution (4K costs more credits)").addDropdown(n=>n.addOption("1K","1K").addOption("2K","2K").addOption("4K","4K \u26A0\uFE0F High Price").setValue(this.plugin.settings.resolution).onChange(async s=>{this.plugin.settings.resolution=s,await this.plugin.saveSettings()})),new o.Setting(e).setName("Language").setDesc("Language for image titles and descriptions").addDropdown(n=>n.addOption("ja","Japanese").addOption("en","English").setValue(this.plugin.settings.language).onChange(async s=>{this.plugin.settings.language=s,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Storage"}),new o.Setting(e).setName("Attachment Folder").setDesc("Folder to save generated images (relative to vault root)").addText(n=>n.setPlaceholder("attachments/ai-summary").setValue(this.plugin.settings.attachmentFolder).onChange(async s=>{this.plugin.settings.attachmentFolder=s,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Content Processing"}),new o.Setting(e).setName("Send Mode").setDesc("How much of the note to send to the AI").addDropdown(n=>n.addOption("full","Full content").addOption("headings","Headings + excerpts").addOption("summary","Summary only").setValue(this.plugin.settings.sendMode).onChange(async s=>{this.plugin.settings.sendMode=s,await this.plugin.saveSettings()})),new o.Setting(e).setName("Max Characters").setDesc("Maximum characters to send (for token optimization)").addText(n=>n.setPlaceholder("30000").setValue(String(this.plugin.settings.maxCharacters)).onChange(async s=>{let i=parseInt(s);!isNaN(i)&&i>0&&(this.plugin.settings.maxCharacters=i,await this.plugin.saveSettings())})),e.createEl("h3",{text:"Safety"}),new o.Setting(e).setName("Create Backup").setDesc("Save a backup of the note before injecting images").addToggle(n=>n.setValue(this.plugin.settings.createBackup).onChange(async s=>{this.plugin.settings.createBackup=s,await this.plugin.saveSettings()})),new o.Setting(e).setName("Backup Location").setDesc("Where to store backups").addDropdown(n=>n.addOption("plugin","Plugin data (lightweight)").addOption("vault","Vault folder (robust)").setValue(this.plugin.settings.backupLocation).onChange(async s=>{this.plugin.settings.backupLocation=s,await this.plugin.saveSettings()}))}},O=class extends o.Modal{constructor(e,t){super(e),this.backup=t}onOpen(){let{contentEl:e}=this;e.createEl("h2",{text:"Backup Content"}),e.createEl("p",{text:`Saved at: ${new Date(this.backup.timestamp).toLocaleString()}`});let t=e.createEl("textarea",{attr:{style:"width: 100%; height: 400px; font-family: monospace;",readonly:"true"}});t.value=this.backup.originalContent,new o.Setting(e).addButton(a=>a.setButtonText("Close").onClick(()=>this.close()))}onClose(){this.contentEl.empty()}};
